<%- include("partials/header") %>

<section class="poll-open-page">
  <article class="thread-card thread-card-wide">
    <div class="thread-head">
      <span class="thread-tag"><%= poll.category_name %></span>
      <span class="thread-meta">Автор: <a href="/profile/<%= poll.user_id %>"><%= poll.username %></a></span>
      <span class="thread-meta">№<%= poll.id %></span>
      <span class="thread-meta timer" data-countdown="<%= poll.end_at %>"></span>
      <span class="thread-meta"><%= poll.is_anonymous ? "Анонимное" : "Публичное" %></span>
      <% if (currentUser) { %>
        <form action="/polls/<%= poll.id %>/favorite" method="POST" class="favorite-form">
          <input type="hidden" name="next" value="<%= `/polls/${poll.id}` %>" />
          <button type="submit" class="favorite-toggle <%= isFavorite ? 'active' : '' %>" title="Избранное">★</button>
        </form>
      <% } %>
    </div>

    <h1 class="thread-title"><%= poll.title %></h1>
    <p class="thread-text"><%= poll.description %></p>

    <% if ((poll.images && poll.images.length) || (poll.videos && poll.videos.length)) { %>
      <div class="thread-media-grid media-grid-open">
        <% (poll.images || []).forEach((img) => { %>
          <a href="<%= img.path %>" target="_blank" rel="noopener noreferrer" class="thumb-link">
            <img src="<%= img.path %>" alt="poll image" class="media-thumb media-open-thumb" loading="lazy" />
          </a>
        <% }) %>
        <% (poll.videos || []).forEach((video) => { %>
          <video controls preload="metadata" class="media-open-video">
            <source src="<%= video.path %>" />
          </video>
        <% }) %>
      </div>
    <% } %>

    <section class="result-box">
      <h3>Результаты (<%= totalVotes %> голосов)</h3>
      <% options.forEach((option) => { %>
        <div class="result-row">
          <div class="result-line"><%= option.option_text %> - <%= option.vote_count %></div>
          <div class="vote-bar">
            <span style="width:<%= totalVotes ? (option.vote_count * 100 / totalVotes).toFixed(1) : 0 %>%"></span>
          </div>
        </div>
      <% }) %>
    </section>

    <% if (!poll.is_anonymous) { %>
      <section class="result-box">
        <h3>Кто проголосовал</h3>
        <% if (!voters.length) { %>
          <p class="muted">Пока нет голосов.</p>
        <% } %>
        <% voters.forEach((vote) => { %>
          <div class="vote-person"><a href="/profile/<%= vote.id %>"><%= vote.username %></a> выбрал(а): <strong><%= vote.option_text %></strong></div>
        <% }) %>
      </section>
    <% } %>

    <% if (currentUser) { %>
      <% if (!userVote && new Date(poll.end_at) > now) { %>
        <form action="/polls/<%= poll.id %>/vote" method="POST" class="vote-form">
          <h3>Проголосовать</h3>
          <div class="vote-options">
            <% options.forEach((option) => { %>
              <label class="vote-option">
                <input type="radio" name="option_id" value="<%= option.id %>" required />
                <span><%= option.option_text %></span>
              </label>
            <% }) %>
          </div>
          <button type="submit" class="submit-wide">Отдать голос</button>
        </form>
      <% } else if (userVote) { %>
        <p class="muted">Вы уже голосовали в этом опросе.</p>
      <% } else { %>
        <p class="muted">Голосование завершено.</p>
      <% } %>

      <form action="/reports" method="POST" class="report-line">
        <input type="hidden" name="poll_id" value="<%= poll.id %>" />
        <input type="text" name="reason" placeholder="Причина жалобы на опрос" required />
        <button type="submit">Жалоба</button>
      </form>
    <% } %>
  </article>

  <article class="thread-card thread-card-wide">
    <h3>Комментарии</h3>
    <% if (currentUser) { %>
      <form action="/polls/<%= poll.id %>/comments" method="POST">
        <textarea name="body" rows="3" required placeholder="Напишите комментарий"></textarea>
        <button type="submit">Отправить</button>
      </form>
    <% } else { %>
      <p class="muted">Чтобы писать комментарии, войдите в аккаунт.</p>
    <% } %>

    <% comments.forEach((comment) => { %>
      <div class="comment-item">
        <div class="comment-head">
          <strong><a href="/profile/<%= comment.user_id %>"><%= comment.username %></a></strong>
          <span class="muted"><%= comment.created_at %></span>
        </div>
        <p><%= comment.body %></p>
        <% if (currentUser) { %>
          <form action="/reports" method="POST" class="report-line">
            <input type="hidden" name="comment_id" value="<%= comment.id %>" />
            <input type="text" name="reason" placeholder="Причина жалобы на комментарий" required />
            <button type="submit">Жалоба</button>
          </form>
        <% } %>
      </div>
    <% }) %>
  </article>
</section>

<%- include("partials/footer") %>
