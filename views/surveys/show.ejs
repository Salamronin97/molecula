<%- include("../partials/header") %>

<article class="survey-item survey-page">
  <div class="survey-meta">
    <span>Автор: <a href="/profile/<%= survey.user_id %>"><%= survey.username %></a></span>
    <span class="timer" data-countdown="<%= survey.end_at %>"></span>
    <span><%= survey.is_anonymous ? "Анонимный" : "Публичный" %></span>
  </div>

  <h1><%= survey.title %></h1>
  <p><%= survey.description %></p>

  <% if (survey.cover_path) { %>
    <img src="<%= survey.cover_path %>" alt="cover" class="survey-cover survey-cover-lg" />
  <% } %>

  <% if ((survey.images && survey.images.length) || (survey.videos && survey.videos.length)) { %>
    <div class="media-grid">
      <% (survey.images || []).forEach((item) => { %>
        <a href="<%= item.path %>" target="_blank" rel="noopener noreferrer">
          <img src="<%= item.path %>" alt="attachment" class="media-thumb" />
        </a>
      <% }) %>
      <% (survey.videos || []).forEach((item) => { %>
        <video controls preload="metadata" class="media-video">
          <source src="<%= item.path %>" />
        </video>
      <% }) %>
    </div>
  <% } %>

  <p class="muted">Всего ответов: <%= responsesCount %></p>

  <div class="share-box">
    <label class="share-label" for="share-link">Публичная ссылка</label>
    <div class="share-row">
      <input id="share-link" type="text" value="<%= `${baseUrl}/surveys/${survey.id}` %>" readonly />
      <button type="button" id="copy-link-btn">Копировать</button>
    </div>
    <img
      class="share-qr"
      src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=<%= encodeURIComponent(`${baseUrl}/surveys/${survey.id}`) %>"
      alt="QR code"
      loading="lazy"
    />
  </div>

  <% if (currentUser && (currentUser.id === survey.user_id || currentUser.is_admin)) { %>
    <div class="owner-actions">
      <a href="/surveys/<%= survey.id %>/analytics" class="btn ghost">Аналитика</a>
      <a href="/surveys/<%= survey.id %>/results.csv" class="btn ghost">Скачать результаты (CSV)</a>
    </div>
  <% } %>
</article>

<section class="card survey-page">
  <h2>Пройти опрос</h2>
  <% if (!currentUser) { %>
    <p>Чтобы отправить ответы, выполните вход.</p>
  <% } else if (hasResponded) { %>
    <p>Вы уже отправили ответы в этом опросе.</p>
  <% } else if (new Date(survey.end_at) <= now) { %>
    <p>Опрос завершен.</p>
  <% } else { %>
    <form action="/surveys/<%= survey.id %>/respond" method="POST">
      <% questions.forEach((question, index) => { %>
        <div class="question-view">
          <h3><%= index + 1 %>. <%= question.question_text %> <%= question.is_required ? "*" : "" %></h3>
          <% if (question.next_question_order) { %>
            <p class="muted">После ответа переход к вопросу №<%= question.next_question_order %></p>
          <% } %>
          <% if (question.question_type === "text") { %>
            <textarea name="q_<%= question.id %>" rows="3" <%= question.is_required ? "required" : "" %>></textarea>
          <% } %>
          <% if (question.question_type === "scale") { %>
            <select name="q_<%= question.id %>" <%= question.is_required ? "required" : "" %>>
              <option value="">Выберите оценку</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          <% } %>
          <% if (question.question_type === "single") { %>
            <% question.options.forEach((option) => { %>
              <label class="option-line">
                <input type="radio" name="q_<%= question.id %>" value="<%= option.id %>" <%= question.is_required ? "required" : "" %> />
                <span><%= option.option_text %></span>
              </label>
            <% }) %>
          <% } %>
          <% if (question.question_type === "multi") { %>
            <% question.options.forEach((option) => { %>
              <label class="option-line">
                <input type="checkbox" name="q_<%= question.id %>" value="<%= option.id %>" />
                <span><%= option.option_text %></span>
              </label>
            <% }) %>
          <% } %>
        </div>
      <% }) %>
      <button type="submit" class="btn">Отправить ответы</button>
    </form>
  <% } %>
</section>

<section class="card survey-page">
  <h2>Результаты голосования</h2>
  <% questions.forEach((question) => { %>
    <% if (question.question_type === "single" || question.question_type === "multi") { %>
      <div class="question-view">
        <h3><%= question.question_text %></h3>
        <% (questionStats[question.id] || []).forEach((row) => { %>
          <div class="result-row">
            <span><%= row.option_text %> - <%= row.vote_count %></span>
          </div>
        <% }) %>
      </div>
    <% } %>
  <% }) %>
</section>

<section class="card survey-page">
  <h2>Комментарии</h2>
  <% if (currentUser) { %>
    <form action="/surveys/<%= survey.id %>/comments" method="POST">
      <textarea name="body" rows="3" required placeholder="Напишите комментарий"></textarea>
      <button type="submit" class="btn">Отправить</button>
    </form>
  <% } %>
  <% comments.forEach((comment) => { %>
    <div class="comment">
      <div class="muted"><a href="/profile/<%= comment.user_id %>"><%= comment.username %></a> · <%= comment.created_at %></div>
      <p><%= comment.body %></p>
      <% if (currentUser) { %>
        <form action="/reports" method="POST" class="report-inline">
          <input type="hidden" name="comment_id" value="<%= comment.id %>" />
          <input type="text" name="reason" required placeholder="Причина жалобы" />
          <button type="submit">Жалоба</button>
        </form>
      <% } %>
    </div>
  <% }) %>
</section>

<%- include("../partials/footer") %>
