<%- include("partials/header") %>

<div class="layout-grid">
  <aside class="left-catalog">
    <% Object.keys(categoryGroups).forEach((groupName) => { %>
      <div class="catalog-group">
        <div class="catalog-title"><%= groupName %></div>
        <div class="catalog-list">
          <% categoryGroups[groupName].forEach((category) => { %>
            <a href="/polls?category=<%= category.slug %>" class="catalog-link <%= selectedCategory === category.slug ? 'active' : '' %>"><%= category.name %></a>
          <% }) %>
        </div>
      </div>
    <% }) %>
  </aside>

  <section class="feed-column">
    <div class="board-tools">
      <form action="/polls" method="GET" class="search-box">
        <% if (selectedCategory) { %>
          <input type="hidden" name="category" value="<%= selectedCategory %>" />
        <% } %>
        <input name="q" value="<%= q || '' %>" type="search" placeholder="Поиск: ID, название, текст описания" />
      </form>
      <a href="/polls/new" class="create-poll-btn">Создать опрос</a>
    </div>

    <% if (!polls.length) { %>
      <article class="thread-card">
        <p>Ничего не найдено в этом разделе.</p>
      </article>
    <% } %>

    <% polls.forEach((poll) => { %>
      <article class="thread-card">
        <div class="thread-head">
          <span class="thread-tag"><%= poll.category_name %></span>
          <span class="thread-meta">Автор: <a href="/profile/<%= poll.user_id %>"><%= poll.username %></a></span>
          <span class="thread-meta">№<%= poll.id %></span>
          <span class="thread-meta timer" data-countdown="<%= poll.end_at %>"></span>
          <% if (currentUser) { %>
            <form action="/polls/<%= poll.id %>/favorite" method="POST" class="favorite-form">
              <input type="hidden" name="next" value="<%= `/polls/${poll.id}` %>" />
              <button type="submit" class="favorite-toggle <%= poll.is_favorite ? 'active' : '' %>" title="Избранное">★</button>
            </form>
          <% } %>
        </div>

        <h2 class="thread-title"><a href="/polls/<%= poll.id %>"><%= poll.title %></a></h2>
        <p class="thread-text"><%= poll.description.length > 260 ? `${poll.description.slice(0, 260)}...` : poll.description %></p>

        <% if ((poll.images && poll.images.length) || (poll.videos && poll.videos.length) || poll.preview_image || poll.preview_video) { %>
          <div class="thread-media-grid">
            <% (poll.images || []).slice(0, 5).forEach((image) => { %>
              <a href="/polls/<%= poll.id %>" class="thumb-link">
                <img src="<%= image.path %>" alt="preview image" class="media-thumb" loading="lazy" />
              </a>
            <% }) %>
            <% (poll.videos || []).slice(0, 3).forEach((video) => { %>
              <a href="/polls/<%= poll.id %>" class="thumb-link">
                <video class="media-thumb" preload="metadata" muted>
                  <source src="<%= video.path %>" />
                </video>
              </a>
            <% }) %>
            <% if (!poll.images?.length && poll.preview_image) { %>
              <a href="/polls/<%= poll.id %>" class="thumb-link">
                <img src="<%= poll.preview_image %>" alt="preview image" class="media-thumb" loading="lazy" />
              </a>
            <% } %>
            <% if (!poll.videos?.length && poll.preview_video) { %>
              <a href="/polls/<%= poll.id %>" class="thumb-link">
                <video class="media-thumb" preload="metadata" muted>
                  <source src="<%= poll.preview_video %>" />
                </video>
              </a>
            <% } %>
          </div>
        <% } %>

        <div class="thread-foot">
          <span>Голосов: <%= poll.vote_count %></span>
          <span>Комментариев: <%= poll.comment_count %></span>
          <span><%= poll.is_anonymous ? "Анонимное" : "Публичное" %></span>
        </div>
      </article>
    <% }) %>
  </section>
</div>

<%- include("partials/footer") %>
